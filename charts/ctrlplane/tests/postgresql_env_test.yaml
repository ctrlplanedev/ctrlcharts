suite: postgresql env vars
templates:
  - charts/api/templates/deployment.yaml
  - charts/migrations/templates/job.yaml
  - charts/workspace-engine/templates/statefulset.yaml
  - templates/secrets.yaml
release:
  name: ctrlplane
tests:
  - it: api uses direct postgres env vars
    template: charts/api/templates/deployment.yaml
    set:
      global:
        postgresql:
          user: ctrlplane-user
          host: db.example.local
          port: "6432"
          database: ctrlplane-db
          password: direct-password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_USER
            value: ctrlplane-user
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_HOST
            value: db.example.local
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PORT
            value: "6432"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_DATABASE
            value: ctrlplane-db
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PASSWORD
            value: direct-password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_URL
            value: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}
          any: true
  - it: migrations uses direct postgres env vars
    template: charts/migrations/templates/job.yaml
    set:
      global:
        postgresql:
          user: ctrlplane-user
          host: db.example.local
          port: "6432"
          database: ctrlplane-db
          password: direct-password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_USER
            value: ctrlplane-user
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_HOST
            value: db.example.local
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PORT
            value: "6432"
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_DATABASE
            value: ctrlplane-db
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PASSWORD
            value: direct-password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_URL
            value: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}
          any: true
  - it: api uses valueFrom postgres password
    template: charts/api/templates/deployment.yaml
    set:
      global:
        postgresql:
          user: ctrlplane-user
          host: db.example.local
          port: "6432"
          database: ctrlplane-db
          password:
            valueFrom:
              secretKeyRef:
                name: postgres-secret
                key: password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_URL
            value: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}
          any: true
  - it: migrations uses valueFrom postgres password
    template: charts/migrations/templates/job.yaml
    set:
      global:
        postgresql:
          user: ctrlplane-user
          host: db.example.local
          port: "6432"
          database: ctrlplane-db
          password:
            valueFrom:
              secretKeyRef:
                name: postgres-secret
                key: password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: POSTGRES_URL
            value: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}
          any: true
