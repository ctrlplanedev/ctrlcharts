suite: secrets management
templates:
  - templates/secrets.yaml
  - charts/api/templates/secrets.yaml
  - charts/web/templates/secrets.yaml
  - charts/api/templates/deployment.yaml
release:
  name: ctrlplane

tests:
  - it: auto-generates the encryption-key secret by default
    template: templates/secrets.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: ctrlplane-encryption-key
      - equal:
          path: kind
          value: Secret
      - isNotEmpty:
          path: data.AES_256_KEY

  - it: points the api at the auto-generated encryption-key secret
    template: charts/api/templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VARIABLES_AES_256_KEY
            valueFrom:
              secretKeyRef:
                name: ctrlplane-encryption-key
                key: AES_256_KEY
          any: true

  - it: skips the encryption-key secret when valueFrom is provided
    template: templates/secrets.yaml
    set:
      global:
        secrets:
          encryptionKey:
            valueFrom:
              secretKeyRef:
                name: my-ext-aes
                key: MY_AES
    asserts:
      - hasDocuments:
          count: 0

  - it: wires the api to an external encryption key via valueFrom
    template: charts/api/templates/deployment.yaml
    set:
      global:
        secrets:
          encryptionKey:
            valueFrom:
              secretKeyRef:
                name: my-ext-aes
                key: MY_AES
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VARIABLES_AES_256_KEY
            valueFrom:
              secretKeyRef:
                name: my-ext-aes
                key: MY_AES
          any: true

  - it: auto-generates the api auth secret by default
    template: charts/api/templates/secrets.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: ctrlplane-api
      - isNotEmpty:
          path: data.AUTH_SECRET

  - it: auto-generates the web auth secret by default
    template: charts/web/templates/secrets.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: ctrlplane-web
      - isNotEmpty:
          path: data.AUTH_SECRET

  - it: points the api at the auto-generated auth secret
    template: charts/api/templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: ctrlplane-api
                key: AUTH_SECRET
          any: true

  - it: skips the api auth secret when valueFrom is provided
    template: charts/api/templates/secrets.yaml
    set:
      global:
        secrets:
          authSecret:
            valueFrom:
              secretKeyRef:
                name: my-ext-auth
                key: MY_AUTH
    asserts:
      - hasDocuments:
          count: 0

  - it: skips the web auth secret when valueFrom is provided
    template: charts/web/templates/secrets.yaml
    set:
      global:
        secrets:
          authSecret:
            valueFrom:
              secretKeyRef:
                name: my-ext-auth
                key: MY_AUTH
    asserts:
      - hasDocuments:
          count: 0

  - it: wires the api to an external auth secret via valueFrom
    template: charts/api/templates/deployment.yaml
    set:
      global:
        secrets:
          authSecret:
            valueFrom:
              secretKeyRef:
                name: my-ext-auth
                key: MY_AUTH
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: my-ext-auth
                key: MY_AUTH
          any: true

  - it: suppresses all secrets when both use valueFrom
    template: templates/secrets.yaml
    set:
      global:
        secrets:
          authSecret:
            valueFrom:
              secretKeyRef:
                name: ext-auth
                key: AUTH
          encryptionKey:
            valueFrom:
              secretKeyRef:
                name: ext-aes
                key: AES
    asserts:
      - hasDocuments:
          count: 0

  - it: wires both external secrets into the api at once
    template: charts/api/templates/deployment.yaml
    set:
      global:
        secrets:
          authSecret:
            valueFrom:
              secretKeyRef:
                name: ext-auth
                key: AUTH
          encryptionKey:
            valueFrom:
              secretKeyRef:
                name: ext-aes
                key: AES
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VARIABLES_AES_256_KEY
            valueFrom:
              secretKeyRef:
                name: ext-aes
                key: AES
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: ext-auth
                key: AUTH
          any: true
